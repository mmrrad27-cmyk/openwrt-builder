name: Build OpenWrt EA8300


on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev \
            libssl-dev python3-distutils rsync unzip zlib1g-dev \
            file wget

      - name: Clone OpenWrt
        run: |
          git clone https://github.com/openwrt/openwrt.git
          cd openwrt
          git checkout v24.10.0

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

       -name: Configure target
       run: |
          cd openwrt
          cat > .config << 'EOF'
          CONFIG_TARGET_ipq40xx=y
          CONFIG_TARGET_ipq40xx_generic=y
          CONFIG_TARGET_ipq40xx_generic_DEVICE_linksys_ea8300=y

          # LuCI
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-ssl=y

          # WiFi drivers (EA8300)
          CONFIG_PACKAGE_kmod-ath10k=y
          CONFIG_PACKAGE_kmod-ath10k-ct=y
          CONFIG_PACKAGE_ath10k-firmware-qca4019=y
          CONFIG_PACKAGE_wireless-regdb=y
          CONFIG_PACKAGE_wpad-basic-mbedtls=y

          # Disable IPv6 packages
          CONFIG_PACKAGE_odhcpd-ipv6only=n
          CONFIG_PACKAGE_odhcpd=n
          EOF

          make defconfig



      - name: Add default settings
        run: |
          cd openwrt
       mkdir -p files/etc/uci-defaults

       cat > files/etc/uci-defaults/99-almadina-defaults << 'EOF'
       #!/bin/sh

       #!/bin/sh

      # Remove WAN interfaces
       uci delete network.wan 2>/dev/null
       uci delete network.wan6 2>/dev/null
       uci commit network


          # Disable DHCP
          uci set dhcp.lan.ignore='1'
          uci commit dhcp

          # Disable DHCP on LAN
          uci set dhcp.lan.ignore='1'
          uci commit dhcp

          # Disable IPv6 RA and DHCPv6
          uci set dhcp.lan.ra='disabled'
          uci set dhcp.lan.dhcpv6='disabled'
          uci set dhcp.lan.ndp='disabled'
          uci commit dhcp


          # Create wireless config from scratch
          uci -q delete wireless
          uci set wireless.radio0=wifi-device
          uci set wireless.radio0.type='mac80211'
          uci set wireless.radio0.path='soc/40000000.wifi'
          uci set wireless.radio0.band='2g'
          uci set wireless.radio0.htmode='HT40'
          uci set wireless.radio0.channel='auto'
          uci set wireless.radio0.disabled='0'

          uci set wireless.radio1=wifi-device
          uci set wireless.radio1.type='mac80211'
          uci set wireless.radio1.path='soc/44000000.wifi'
          uci set wireless.radio1.band='5g'
          uci set wireless.radio1.htmode='VHT80'
          uci set wireless.radio1.channel='auto'
          uci set wireless.radio1.disabled='0'

          uci set wireless.radio2=wifi-device
          uci set wireless.radio2.type='mac80211'
          uci set wireless.radio2.path='soc/48000000.wifi'
          uci set wireless.radio2.band='5g'
          uci set wireless.radio2.htmode='VHT80'
          uci set wireless.radio2.channel='auto'
          uci set wireless.radio2.disabled='0'

          # Generate wireless config
          wifi config

          # Enable all radios
          for dev in $(uci show wireless | grep "=wifi-device" | cut -d. -f2 | cut -d= -f1); do
          uci set wireless.$dev.disabled='0'
          done

          # Configure all SSIDs
          for iface in $(uci show wireless | grep "=wifi-iface" | cut -d. -f2 | cut -d= -f1); do
          uci set wireless.$iface.ssid='Almadina'
          uci set wireless.$iface.encryption='none'
          uci set wireless.$iface.mode='ap'
          uci set wireless.$iface.network='lan'
          uci set wireless.$iface.disabled='0'
          done

          uci commit wireless
          exit 0

          EOF

          chmod +x files/etc/uci-defaults/99-almadina-defaults

      - name: Build firmware
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-ea8300
          path: openwrt/bin/targets/ipq40xx/generic/*.bin
