name: Build OpenWrt EA8300


on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev \
            libssl-dev python3-distutils rsync unzip zlib1g-dev \
            file wget

      - name: Clone OpenWrt
        run: |
          git clone https://github.com/openwrt/openwrt.git
          cd openwrt
          git checkout v24.10.0

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure target
        run: |
          cd openwrt
          make defconfig
          ./scripts/diffconfig.sh > diffconfig
          cat << 'EOF' > diffconfig
          CONFIG_TARGET_ipq40xx=y
          CONFIG_TARGET_ipq40xx_generic=y
          CONFIG_TARGET_ipq40xx_generic_DEVICE_linksys_ea8300=y
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-ssl=y
          EOF
          cat diffconfig >> .config
          make defconfig


      - name: Add default settings
        run: |
          cd openwrt
          mkdir -p files/etc/uci-defaults

          cat > files/etc/uci-defaults/99-almadina-defaults << 'EOF'
          #!/bin/sh

          #!/bin/sh

          # Disable DHCP
          uci set dhcp.lan.ignore='1'
          uci commit dhcp

          # Create wireless config from scratch
          uci -q delete wireless
          uci set wireless.radio0=wifi-device
          uci set wireless.radio0.type='mac80211'
          uci set wireless.radio0.path='soc/40000000.wifi'
          uci set wireless.radio0.band='2g'
          uci set wireless.radio0.htmode='HT40'
          uci set wireless.radio0.channel='auto'
          uci set wireless.radio0.disabled='0'

          uci set wireless.radio1=wifi-device
          uci set wireless.radio1.type='mac80211'
          uci set wireless.radio1.path='soc/44000000.wifi'
          uci set wireless.radio1.band='5g'
          uci set wireless.radio1.htmode='VHT80'
          uci set wireless.radio1.channel='auto'
          uci set wireless.radio1.disabled='0'

          uci set wireless.radio2=wifi-device
          uci set wireless.radio2.type='mac80211'
          uci set wireless.radio2.path='soc/48000000.wifi'
          uci set wireless.radio2.band='5g'
          uci set wireless.radio2.htmode='VHT80'
          uci set wireless.radio2.channel='auto'
          uci set wireless.radio2.disabled='0'

          # 3 WiFi interfaces – open – same SSID
          for i in 0 1 2; do
          uci set wireless.default_radio$i=wifi-iface
          uci set wireless.default_radio$i.device="radio$i"
          uci set wireless.default_radio$i.mode='ap'
          uci set wireless.default_radio$i.network='lan'
          uci set wireless.default_radio$i.ssid='Almadina'
          uci set wireless.default_radio$i.encryption='none'
          done

          uci commit wireless
          exit 0

          EOF

          chmod +x files/etc/uci-defaults/99-almadina-defaults

      - name: Build firmware
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-ea8300
          path: openwrt/bin/targets/ipq40xx/generic/*.bin
