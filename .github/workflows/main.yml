name: Build OpenWrt EA8300 v1


on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev \
            libssl-dev python3-distutils rsync unzip zlib1g-dev \
            file wget

      - name: Clone OpenWrt
        run: |
          git clone https://github.com/openwrt/openwrt.git
          cd openwrt
          git checkout v24.10.0

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure target
        run: |
          cd openwrt
          make defconfig

          sed -i 's/# CONFIG_TARGET_ipq40xx is not set/CONFIG_TARGET_ipq40xx=y/' .config
          sed -i 's/# CONFIG_TARGET_ipq40xx_generic is not set/CONFIG_TARGET_ipq40xx_generic=y/' .config
          sed -i 's/# CONFIG_TARGET_ipq40xx_generic_DEVICE_linksys_ea8300 is not set/CONFIG_TARGET_ipq40xx_generic_DEVICE_linksys_ea8300=y/' .config

          sed -i 's/# CONFIG_PACKAGE_luci is not set/CONFIG_PACKAGE_luci=y/' .config
          sed -i 's/# CONFIG_PACKAGE_luci-ssl is not set/CONFIG_PACKAGE_luci-ssl=y/' .config

          make defconfig

      - name: Add default settings
        run: |
          cd openwrt
          mkdir -p files/etc/uci-defaults

          cat > files/etc/uci-defaults/99-almadina-defaults << 'EOF'
          #!/bin/sh

          # Disable DHCP
          uci set dhcp.lan.ignore='1'
          uci commit dhcp

          # Enable WiFi and set SSID
          for dev in \$(uci show wireless | grep "=wifi-device" | cut -d. -f2 | cut -d= -f1); do
            uci set wireless.\$dev.disabled='0'
          done

          i=0
          for iface in \$(uci show wireless | grep "=wifi-iface" | cut -d. -f2 | cut -d= -f1); do
            uci set wireless.\$iface.ssid='Almadina'
            uci set wireless.$iface.encryption='none'
            uci set wireless.$iface.key=''
            uci set wireless.\$iface.disabled='0'
            i=\$((i+1))
          done

          uci commit wireless
          exit 0
          EOF

          chmod +x files/etc/uci-defaults/99-almadina-defaults

      - name: Build firmware
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-ea8300
          path: openwrt/bin/targets/ipq40xx/generic/*.bin
